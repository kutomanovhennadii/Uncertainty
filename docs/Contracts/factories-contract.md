# Factories Contract for UDouble

Этот документ фиксирует полный и неизменяемый набор фабрик создания `UDouble`.
Документ дополняет core-contract и определяет правила и семантику формирования
значений с неопределённостью.

Все фабрики ниже являются частью стабильного API. Их семантика неизменяема.

-------------------------------------------------------------------------------

## 1. Общие принципы фабрик

1. UDouble всегда представляет собой число с гауссовской неопределённостью.
2. Все фабрики возвращают immutable-структуру.
3. Не существует “магической” фабрики для идеального точного числа.
   Точное значение создаётся через FromMeanVar(mean, 0).
4. Любые входные данные числовых типов автоматически поднимаются в модель
   неопределённости согласно IEEE-754 (машинная ошибка).
5. Любая фабрика обязана документировать свои допущения и сохранять целостность
   модели неопределённости.

-------------------------------------------------------------------------------

## 2. Математические фабрики

### 2.1 FromMeanVar(mean, variance)

Создаёт UDouble напрямую из математических параметров:

public static UDouble FromMeanVar(double mean, double variance)

Требования:
- variance >= 0
- variance = 0 разрешено и используется как способ создания точно определённого числа
- отсутствует внутренняя магия или автоматическая коррекция значений

### 2.2 FromMeanStd(mean, stdDev)

public static UDouble FromMeanStd(double mean, double stdDev)

stdDev преобразуется в variance как stdDev * stdDev.

Назначение:
- удобство для физических и инженерных расчётов
- эквивалентно FromMeanVar(mean, variance)

-------------------------------------------------------------------------------

## 3. Фабрики из машинных типов

### 3.1 FromDouble(x)

public static UDouble FromDouble(double x)

Семантика:
- учитывается машинная ошибка представления числа x
- ulp(x) определяется на основе экспоненты
- variance = (0.5 * ulp(x))^2

Это корректное представление реальной неопределённости double.

### 3.2 FromFloat(x)

public static UDouble FromFloat(float x)

Аналогично FromDouble, но с точностью float.

-------------------------------------------------------------------------------

## 4. Имплицитные преобразования

Тип поддерживает неявные преобразования:

UDouble x = 5;
UDouble a = 3.14;
UDouble b = 5f;

Семантика:
- используется FromDouble или FromFloat
- variance учитывает машинную неопределённость исходного типа
- преобразование никогда не создаёт "точного" числа

-------------------------------------------------------------------------------

## 5. Фабрика из набора данных

UDouble.FromData(IEnumerable<T> data)

Допустимые типы данных:
- int
- float
- double
- UDouble

Алгоритм:
1. Каждый элемент приводится к UDouble:
   - int, float, double → FromDouble / FromFloat
   - UDouble → сохраняется как есть

2. Математическое ожидание среднего:
   mean = Average(xᵢ.Mean)

3. Выборочная дисперсия наблюдений (n > 1):
   sigma²_stat = Sum((xᵢ.Mean – mean)^2) / (n – 1)

4. Дисперсия среднего:
   variance_stat = sigma²_stat / n

5. Инструментальная неопределённость:
   variance_inst = Average(xᵢ.Variance)

6. Итоговая дисперсия:
   variance_total = variance_stat + variance_inst

7. Результат:
   return UDouble.FromMeanVar(mean, variance_total)

Особенности:
- корректность согласована с метрологической моделью UC (uncertainty of the mean)
- одинаково работает для смешанных типов данных

-------------------------------------------------------------------------------

## 6. Сводная таблица фабрик

Фабрика                        | Семантика                               | Варианс
------------------------------|------------------------------------------|------------------------------
FromMeanVar(mean, variance)   | Прямое создание                          | variance
FromMeanStd(mean, stdDev)     | Альтернативная форма ввода               | stdDev^2
FromDouble(x)                 | Учитывает машинную ошибку double         | (0.5 * ulp(x))^2
FromFloat(x)                  | Учитывает машинную ошибку float          | (0.5 * ulp(x))^2
Implicit int/float/double     | То же, что соответствующая фабрика       | см. выше
FromData(IEnumerable<T>)      | Статистика + погрешность инструмента     | variance_stat + variance_inst

-------------------------------------------------------------------------------

## 7. Инварианты фабрик

Все фабрики обязаны соблюдать следующие правила:

- отрицательная дисперсия невозможна
- StdDev всегда вычисляется как sqrt(variance)
- все операции детерминированы и не содержат скрытой магии
- одинаковая семантика во всех языках (C#, Python, C++, JS)

-------------------------------------------------------------------------------

## 8. Минимальный эталон набора фабрик

Пример интерфейсного набора (не реализация):

public static UDouble FromMeanVar(double mean, double variance)
public static UDouble FromMeanStd(double mean, double stdDev)
public static UDouble FromDouble(double x)
public static UDouble FromFloat(float x)
public static UDouble FromData(IEnumerable<T> data)

UDouble supports implicit conversions from int, float, double.

-------------------------------------------------------------------------------

## 9. Статус документа

Данный документ является финальным контрактом фабрик для ядра и не может
быть изменён в несовместимых версиях библиотеки. Любые новые фабрики должны быть
расширением, а не изменением существующих.

-------------------------------------------------------------------------------
