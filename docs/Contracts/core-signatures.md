# Core Signatures — UDouble Public API Contract

Документ фиксирует окончательный публичный API типа UDouble. Сигнатуры отражают структуру данных, доступные фабрики, правила преобразований и набор операторов. Реализация в языках C#, C++, Python и других должна следовать этим контрактам без изменения семантики.

## 1. Тип UDouble

### 1.1 Назначение
UDouble представляет скалярную величину с малой случайной ошибкой, аппроксимированной локально нормальным распределением. Тип является immutable. Внутри хранятся только Mean и Variance. Свойство StdDev вычисляется из Variance.

### 1.2 Публичные свойства
UDouble
- Mean : double         // числовое среднее
- Variance : double     // дисперсия (σ²)
- StdDev : double       // стандартное отклонение (sqrt(Variance))

Все свойства только для чтения. Изменение значений возможно только через фабрики и арифметические операции.

## 2. Фабрики создания значений

UDouble не предоставляет публичных конструкторов. Все экземпляры создаются через фабрики.

### 2.1 Основные фабрики
UDouble.FromMeanVar(mean: double, variance: double)
UDouble.FromMeanStd(mean: double, stdDev: double)

### 2.2 Фабрики из числовых типов
Все преобразования explicit:
(UDouble)double      → UDouble.FromDouble(x)
(UDouble)float       → UDouble.FromFloat(x)
(UDouble)int         → UDouble.FromInt(x)

Фабрики:
UDouble.FromDouble(x: double)   // variance = (0.5 ulp(x))²
UDouble.FromFloat(x: float)     // аналогично для float
UDouble.FromInt(x: int)         // variance = 0

### 2.3 Фабрики из данных (выборка)
UDouble.FromSample(data: IEnumerable<double>)
UDouble.FromSample(data: IEnumerable<UDouble>)

Для первой выборки variance вычисляется как дисперсия среднего (σ²/n).  
Для второй учитывается индивидуальная Variance каждого элемента.

## 3. Арифметика

### 3.1 Обязательные операторы
a + b  
a - b  
a * b  
a / b  

Они должны использовать линейную пропагацию ошибки первого порядка с поправками численной устойчивости (см. математический контракт).

### 3.2 Дополнительные функции
Список функций ядра, который должен быть минимально реализован:
Sin(UDouble)  
Cos(UDouble)  
Tan(UDouble)  
Asin(UDouble)  
Acos(UDouble)  
Atan(UDouble)  
Atan2(UDouble, UDouble)  
Sqrt(UDouble)  
Pow(UDouble, double)  
Exp(UDouble)  
Ln(UDouble)

Все функции используют правило Var(f(x)) ≈ (f′(x))² Var(x) с локальными корректировками для устойчивости.

## 4. Операторы сравнения

### 4.1 Правила сравнения
Все операторы сравнивают только Mean:

a < b     ⇔ a.Mean <  b.Mean  
a > b     ⇔ a.Mean >  b.Mean  
a <= b    ⇔ a.Mean <= b.Mean  
a >= b    ⇔ a.Mean >= b.Mean  
a == b    ⇔ a.Mean == b.Mean  
a != b    ⇔ a.Mean != b.Mean

Variance не участвует в сравнении.  
Семантика — числовое сравнение средних значений.

### 4.2 Никаких интервальных сравнений
UDouble не определяет логики “перекрытия интервалов” или вероятности превышения. Эти задачи остаются на уровне пользовательского кода.

## 5. Преобразования типов

### 5.1 Разрешённые explicit преобразования
(double)UDouble    → возвращает Mean  
(UDouble)double    → UDouble.FromDouble(x)  
(UDouble)float     → UDouble.FromFloat(x)  
(UDouble)int       → UDouble.FromInt(x)

### 5.2 Запрещённые implicit преобразования
Implicit-преобразования отсутствуют полностью для всех типов.

## 6. Edge Cases

### 6.1 Недопустимые аргументы
Следующие значения вызывают исключение при создании:
double.NaN  
double.PositiveInfinity  
double.NegativeInfinity  
Аналогично для float.

### 6.2 Ошибки области определения
Операции log(x) при x ≤ 0, sqrt(x) при x < 0, acos/asin при |x|>1 вызывают исключение.  
Это ошибки входных данных, а не неопределённости.

### 6.3 Численная нестабильность
Если вычисление дисперсии приводит к значению, превышающему допустимый диапазон double, применяется saturating-ограничение:
Variance = min(VarianceComputed, VarianceMax)

VarianceMax определяется реализацией, но должно быть не меньше 1e300.

### 6.4 Division by zero
a / b запрещено, если b.Mean == 0.  
Это приводит к исключению.  
Для малых b.Mean применяется saturating-ограничение вместо исключения.

## 7. Ограничения модели
UDouble не хранит covariance и не моделирует зависимость ошибок.  
UDouble не представляет полное распределение — только локальную нормальную аппроксимацию.  
Модель корректна только для малых ошибок и функций, локально близких к линейным.

## 8. Назначение документа
Этот документ определяет окончательный публичный API ядра. Реализация должна соответствовать ему без изменений. Все будущие надстройки (векторы неопределённости, матрицы, фильтры Калмана) строятся поверх данного контракта и не изменяют его структуру.

